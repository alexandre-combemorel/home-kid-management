# syntax=docker/dockerfile:1.7-labs
FROM node:20.18.1-alpine3.21
# Installing libvips-dev for sharp Compatibility
RUN apk update && apk add --no-cache build-base gcc autoconf automake zlib-dev libpng-dev nasm bash vips-dev git
RUN npm install -g pnpm
ARG NODE_ENV
ARG HOST=0.0.0.0
ARG PORT=1337
# Secrets
ARG APP_KEYS
ARG API_TOKEN_SALT
ARG ADMIN_JWT_SECRET
ARG TRANSFER_TOKEN_SALT
ARG JWT_SECRET
# Database
ARG DATABASE_CLIENT=postgres
ARG DATABASE_HOST
ARG DATABASE_PORT
ARG DATABASE_NAME=staging
ARG DATABASE_USERNAME
ARG DATABASE_PASSWORD
ARG DATABASE_SSL=false
# Assets upload
ARG SCALEWAY_ACCESS_KEY_ID
ARG SCALEWAY_ACCESS_SECRET
ARG SCALEWAY_REGION=fr-par
ARG SCALEWAY_ENDPOINT=https://s3.fr-par.scw.cloud/
ARG SCALEWAY_BUCKET

# Strapi ENV
ENV HOST=${HOST}
ENV PORT=${PORT}

# Secrets
ENV APP_KEYS=${APP_KEYS}
ENV API_TOKEN_SALT=${API_TOKEN_SALT}
ENV ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET}
ENV TRANSFER_TOKEN_SALT=${TRANSFER_TOKEN_SALT}
ENV JWT_SECRET=${JWT_SECRET}
# Database
ENV DATABASE_CLIENT=${DATABASE_CLIENT}
ENV DATABASE_HOST=${DATABASE_HOST}
ENV DATABASE_PORT=${DATABASE_PORT}
ENV DATABASE_NAME=${DATABASE_NAME}
ENV DATABASE_USERNAME=${DATABASE_USERNAME}
ENV DATABASE_PASSWORD=${DATABASE_PASSWORD}
ENV DATABASE_SSL=${DATABASE_SSL}
# Assets upload
ENV SCALEWAY_ACCESS_KEY_ID=${SCALEWAY_ACCESS_KEY_ID}
ENV SCALEWAY_ACCESS_SECRET=${SCALEWAY_ACCESS_SECRET}
ENV SCALEWAY_REGION=${SCALEWAY_REGION}
ENV SCALEWAY_ENDPOINT=${SCALEWAY_ENDPOINT}
ENV SCALEWAY_BUCKET=${SCALEWAY_BUCKET}

ENV NODE_ENV=${NODE_ENV}
ENV PNPM_HOME="/home/node/.local/share/pnpm"
ENV PATH="${PNPM_HOME}:${PATH}"

WORKDIR /opt/app
RUN pnpm add --global node-gyp
COPY ./config ./config
COPY ./database ./database
COPY ./public ./public
COPY ./scripts ./scripts
COPY ./src ./src
COPY ./types ./types
COPY favicon.png ./favicon.png
COPY package.json ./package.json
COPY pnpm-lock.yaml ./pnpm-lock.yaml
COPY README.md ./README.md
COPY tsconfig.json ./tsconfig.json
RUN chown -R node:node /opt/app
USER node
RUN pnpm install
RUN pnpm build
EXPOSE 1337
CMD pnpm start